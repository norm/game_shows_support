#!/usr/bin/env bash -euo pipefail
#
# Generate files from the raw captures (mkv) which is usable in Davinci
# Resolve (mp4), adjusting the volume up to a sensible working level.
#
# For each new piece of footage, create a text file for capturing the
# contents of the footage for later reference, and a Things task to
# track whether or not this has been done.

for mkv in raw/*mkv; do
    [ ! -f "$mkv" ] && break

    mp4="$( echo "$mkv" | sed -e 's/^raw/footage/' -e 's/.mkv/.mp4/')"
    notes="$( echo "$mkv" | sed -e 's/^raw/footage/' -e 's/.mkv/.txt/')"

    if [ ! -f "$mp4" ]; then
        status "++ {green}$mp4 [$(duration "$mkv")]"
        [ -n "${DRY_RUN:-}" ] && continue

        # convert to mp4, boosting the volume
        ffmpeg \
            -loglevel error \
            -stats \
            -i "$mkv" \
            -vcodec copy \
            -filter:a "volume=15dB" \
            "$mp4"

        # create annotation files for each video, and open
        # the video and text as a prompt to fill it out
        touch "$notes"
        subl "$notes"
        play "$mp4"

        chose=0
        while [ $chose = 0 ]; do
            status -cnr "Keep: y/n? "
            read -N1 -s keeper
            echo -n $keeper
            case $keeper in
                n|N)    chose=1
                        rm "$mp4" "$notes" "$mkv"
                        ;;
                y|Y)    chose=1
                        add_to_things "Properly annotate $(basename "$mp4")"
                        ;;
                *)      sleep 1
                        ;;
            esac
        done
        echo ''
    fi
done
