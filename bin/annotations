#!/usr/bin/env bash -euo pipefail
#
# annotations
#     re-edit annotations one by one, in newest-first order
#
# Usage:
#     annotations [empty | glob*]
#
#     empty   only edit unfinished annotation files
#     glob*   only edit annotations that match the provided filename pattern

footage=(footage/*mp4)
for ((i=${#footage[@]}-1; i>=0; i--)); do
    mp4="${footage[$i]}"

    # skip rendered maps
    [[ "$mp4" = footage/*Map\ Base* ]] && continue

    notes="$( echo "$mp4" | sed -e 's/.mp4/.txt/')"
    [ ! -f "$notes" ] && cat footage/template.txt > "$notes"

    if [ "${1:-}" = empty ]; then
        size=$(stat -f'%z' "$notes")
        placeholders=$(grep 0.00.00 "$notes" || true)

        if [ "$size" -gt 10 -a -z "$placeholders" ]; then
            continue
        fi
        [ "$size" -lt 10 ] && cat footage/template.txt > "$notes"
    else
        # only edit matching filenames
        [[ "$mp4" != *${1:-}* ]] && continue
    fi

    status "++ {yellow}$notes"
    [ -n "${DRY_RUN:-}" ] && continue

    play "$mp4"
    subl --new-window --wait "$notes"
done
