#!/bin/bash -euo pipefail
#
# annotations
#     re-edit annotations one by one, in newest-first order
#
# Usage:
#     annotations [empty | glob*]
#
#     empty   only edit empty annotation files
#     glob*   only edit annotations that match the provided filename pattern

footage=(footage/*mp4)
for ((i=${#footage[@]}-1; i>=0; i--)); do
    mp4="${footage[$i]}"

    # skip rendered maps
    [[ "$mp4" = footage/*Map\ Base* ]] && continue

    text="$( echo "$mp4" | sed -e 's/.mp4/.txt/')"
    [ ! -f "$text" ] && touch "$text"

    if [ "${1:-}" = empty ]; then
        # only edit empty files
        size=$(stat -f'%z' "$text")
        [ "$size" -gt 0 ] && continue
    else
        # only edit matching filenames
        [[ "$mp4" != *${1:-}* ]] && continue
    fi

    status "++ {yellow}$text"
    [ -n "${DRY_RUN:-}" ] && continue

    subl --new-window --wait "$text"
    play "$mp4"
done
